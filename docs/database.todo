# modules/database 実装TODO

## 概要
現在のシステムは以下の5つのルールを実装することを目的としている：
1. **Cooccurrence (共起確率)**: AならBの確率
2. **Conflict (絶対的ルール)**: AならBはありえない (Cooccurrenceより信憑性が高い)
3. **Similarity (類似性)**: AとBは類似タグ (無意味なプロンプトの羅列を避ける)
4. **Rating Steering (評価誘導)**: Aを使うとrating: .. になりやすい
5. **LoRA Association (LoRA関連性)**: LoRA C は A に関連がある

学習方法: タグの羅列及び差分、正解を与えることによる数式の疑似学習 (またはWord2Vecを使用)

---

## 🔴 未実装・改善が必要な機能

### 3. Similarity (類似性) 🔴
現状: **未実装**  
目的: 無意味なプロンプトの羅列を避ける  
**TODO:**
- [ ] **類似性モデルの選択と実装**
  - [ ] 具体的な実装提案：PPMI行列を使ったコサイン類似度
  - [ ] `SimilarityMatrix` クラスの設計・実装
  - [ ] `calculate_similarity(tag_a: str, tag_b: str) -> float` メソッド
  
- [ ] **ビームサーチへの統合**
  - [ ] 類似性スコアのペナルティ計算
  - [ ] 類似タグが連続する場合のスコア減衰
  - [ ] `ScoringFunction` に類似性チェックを追加
  - [ ] パラメータ調整 (類似性ペナルティの重み)

### 4. Rating Steering (評価誘導) - 統合 🔴
現状: データ計算のみ実装、推論エンジンに未統合  
**TODO:**
- [ ] **Rating目標の指定機能**
  - [ ] `PromptInferenceEngine` に `target_rating` パラメータを追加
  - [ ] 目標ratingに近づくタグを優先的に選択
  
- [ ] **Ratingスコアリング機能**
  - [ ] `ScoringFunction` にrating誘導の計算を追加
  - [ ] 現在のタグセットから予測されるrating分布の計算
  - [ ] 目標ratingとの距離をスコアに反映
  - [ ] `calculate_rating_affinity(tags: Set[str], target_rating: str) -> float`
  
- [ ] **ビームサーチでのRating制御**
  - [ ] Rating予測値を各ビーム状態に追加
  - [ ] Multi-objective最適化の実装 (共起 + rating)

### 5. LoRA Association (LoRA関連性) 🔴
現状: **未実装**  
**TODO:**
- [ ] **推論エンジンへの統合**
  - [ ] `PromptInferenceEngine` に `active_loras` パラメータを追加
  - [ ] LoRA関連タグの優先度向上
  - [ ] LoRA競合の検出 (複数LoRAの相性チェック)

---

### TODO:
- [ ] **データ差分学習の実装**
  - [ ] 既存マトリクスへの増分更新機能
  - [ ] 新規データでの再学習 vs 追加学習の選択
  - [ ] マトリクスのバージョン管理

---

## 📊 Word2Vec / 埋め込みベクトル統合

### Option 1: Gensim Word2Vec
**TODO:**
- [ ] Gensimのインストール・セットアップ
- [ ] タグリストからWord2Vecモデルを学習
- [ ] `modules/database/embeddings.py` の作成
- [ ] `TagEmbedding` クラスの実装
  - [ ] `train(tag_lists: List[List[str]])`
  - [ ] `get_similar_tags(tag: str, top_k: int)`
  - [ ] `calculate_similarity(tag_a: str, tag_b: str)`
  
### Option 2: 共起ベースの埋め込み
**TODO:**
- [ ] PMI行列から低次元埋め込みを生成 (SVD/PCA)
- [ ] 埋め込み空間でのクラスタリング
- [ ] 類似タググループの可視化

---

## 🧪 テスト・検証

### 単体テスト
- [ ] `CooccurrenceMatrix` のテスト
- [ ] `ConflictMap` の自動検出テスト
- [ ] `SimilarityMatrix` のテスト
- [ ] Rating予測精度のテスト
- [ ] LoRA関連性の検証

### 統合テスト
- [ ] End-to-endのプロンプト生成テスト
- [ ] 実際の画像生成での品質評価
- [ ] Rating目標達成率の測定
- [ ] 生成プロンプトの多様性評価

### 評価指標
- [ ] プロンプトの意味的一貫性スコア
- [ ] 競合ルール違反率
- [ ] Rating予測精度
- [ ] ユーザー満足度 (主観評価)

---

## 📝 ドキュメント・ツール

- [ ] **APIドキュメント**
  - [ ] 各クラス・メソッドの詳細説明
  - [ ] 使用例コードの追加
  
- [ ] **データフォーマット仕様書**
  - [ ] マトリクスJSONのスキーマ定義
  - [ ] LoRA関連データの形式
  
- [ ] **可視化ツール**
  - [ ] タグ共起ネットワークの可視化
  - [ ] Rating分布のヒートマップ
  - [ ] 埋め込み空間の2D/3Dプロット
  
- [ ] **GUI/CLI ツール**
  - [ ] インタラクティブなプロンプト生成UI
  - [ ] マトリクス管理用CLIツール
  - [ ] 競合ルールエディタ

---

## 🎯 優先度別実装順序

### Phase 1: 基盤の完成 (高優先度)
1. preprocessing.py の完成とマトリクス保存
2. Rating Steering の推論エンジン統合
3. 単体テストの整備

### Phase 2: 類似性機能 (中優先度)
1. 類似性モデルの選択・実装
2. ビームサーチへの統合
3. パラメータチューニング

### Phase 3: 高度な機能 (中優先度)
1. Conflict自動検出
2. LoRA Association の実装
3. データ差分学習

### Phase 4: ツール・UX向上 (低優先度)
1. 可視化ツール
2. GUI/CLIツール
3. ドキュメント整備

---

## 🔬 実験的アイデア

- [ ] **Multi-modal学習**: 画像特徴量とタグの共同学習
- [ ] **時系列分析**: トレンドタグの検出と優先度調整
- [ ] **ユーザーフィードバックループ**: 生成結果の評価を学習に反映
- [ ] **Transfer Learning**: 大規模タグデータセット (Danbooru等) の活用
- [ ] **Prompt Optimization**: 遺伝的アルゴリズムによる最適プロンプト探索

---

## 📌 備考

### 現在の実装の強み
- PMIベースの共起行列により、単純確率より意味のある関連性を捉えている
- ビームサーチによる探索的なプロンプト生成
- Personal/General マトリクスのブレンディング

### 改善の余地
- 類似性チェックがないため、意味的に重複するタグを生成する可能性
- Rating制御が推論に使われていない
- LoRA対応が未実装
- 自動競合検出がない

### データ要件
- 十分な量のタグ付き画像データ (推奨: 1000枚以上)
- Rating情報付きデータ
- (Optional) LoRA使用履歴データ
